<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Boka flytt – CityTransport</title>
<style>
  body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:0; }
  header { text-align:center; padding:40px 20px 20px; background:#333; color:white; }
  header h1 { font-size:2.5rem; margin-bottom:10px; }
  header p { font-size:1.2rem; color:#ddd; }
  #booking { max-width:900px; margin:40px auto; padding:20px; background:white; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.1); text-align:center; }
  h2 { margin-top:30px; color:#333; }
  #calendar table { border-collapse: collapse; width:100%; max-width:700px; margin:20px auto; box-shadow:0 4px 10px rgba(0,0,0,0.1); border-radius:10px; overflow:hidden; }
  #calendar th, #calendar td { padding:12px; text-align:center; cursor:pointer; }
  #calendar td.available { background-color:#d4f4dd; transition:0.2s; }
  #calendar td.available:hover { background-color:#a8e6a1; }
  #calendar td.booked { background-color:#f4c2c2; cursor:not-allowed; }
  #time-select { display:none; margin:20px auto; padding:10px; font-size:1rem; border-radius:5px; border:1px solid #ccc; }
  #customer-form { display:none; max-width:400px; margin:20px auto; text-align:left; }
  #customer-form input, #customer-form textarea { width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; }
  #customer-form button { background-color:#28a745; color:white; padding:12px 20px; border:none; border-radius:5px; cursor:pointer; width:100%; font-size:1rem; }
  #customer-form button:hover { background-color:#218838; }
  #status { margin-top:15px; font-weight:bold; color:#333; text-align:center; }
</style>
</head>
<body>

<header>
  <h1>Boka din flytt med CityTransport</h1>
  <p>Välj ett datum, se tillgängliga tider och boka enkelt direkt här.</p>
</header>

<section id="booking">
  <h2>Välj datum</h2>
  <div id="calendar"></div>

  <h2>Välj tid</h2>
  <select id="time-select">
    <option value="">Välj tid</option>
  </select>

  <form id="customer-form">
    <input type="text" id="name" name="name" placeholder="Ditt namn" required>
    <input type="email" id="email" name="email" placeholder="Din e-post" required>
    <input type="tel" id="phone" name="phone" placeholder="Ditt telefonnummer" required>
    <textarea id="message" name="message" placeholder="Meddelande (valfritt)"></textarea>
    <button type="submit">Skicka bokning</button>
  </form>

  <p id="status"></p>
</section>

<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<script>
  emailjs.init("E7HH_m3tC91tBo8Vr"); // Din Public Key

  const calendarEl = document.getElementById('calendar');
  const timeSelect = document.getElementById('time-select');
  const customerForm = document.getElementById('customer-form');
  const status = document.getElementById('status');
  let selectedDate = null;

  // Testdata för bokade tider
  let bookedSlots = {}; // { "2025-08-30": ["16:00","21:00"], ... }

  function getAvailableTimes(dateStr){
    const date = new Date(dateStr);
    const day = date.getDay(); // 0=Sun, 6=Sat
    let times = [];
    if(day>=1 && day<=5){ // mån-fre 16:00–00:00
      for(let h=16; h<24; h+=5){
        times.push(h.toString().padStart(2,"0")+":00");
      }
    } else { // lör-sön 0-24
      for(let h=0; h<24; h+=5){
        times.push(h.toString().padStart(2,"0")+":00");
      }
    }
    // ta bort redan bokade tider
    if(bookedSlots[dateStr]){
      times = times.filter(t => !bookedSlots[dateStr].includes(t));
    }
    return times;
  }

  function generateCalendar() {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    let table = `<table><tr>`;
    const weekdays = ["Sön","Mån","Tis","Ons","Tor","Fre","Lör"];
    weekdays.forEach(d => table+=`<th>${d}</th>`); 
    table += `</tr><tr>`;
    for(let i=0;i<firstDay.getDay();i++) table += `<td></td>`;
    for(let day=1; day<=lastDay.getDate(); day++){
      const date = new Date(year, month, day);
      const dayStr = date.toISOString().split('T')[0];
      const cls = bookedSlots[dayStr] ? "booked" : "available";
      table += `<td class="${cls}" data-date="${dayStr}">${day}</td>`;
      if((day+firstDay.getDay())%7===0) table+=`</tr><tr>`;
    }
    table+=`</tr></table>`;
    calendarEl.innerHTML = table;

    document.querySelectorAll('#calendar td.available').forEach(cell => {
      cell.addEventListener("click", () => {
        selectedDate = cell.dataset.date;
        const times = getAvailableTimes(selectedDate);
        timeSelect.innerHTML = `<option value="">Välj tid</option>`;
        times.forEach(t => {
          const option = document.createElement("option");
          option.value = t; option.textContent = t;
          timeSelect.appendChild(option);
        });
        timeSelect.style.display = times.length>0 ? "block" : "none";
        customerForm.style.display="none";
        status.textContent = times.length===0 ? "Inga lediga tider denna dag." : "";
      });
    });
  }

  generateCalendar();

  timeSelect.addEventListener("change", () => {
    if(timeSelect.value){
      customerForm.style.display="block";
    } else {
      customerForm.style.display="none";
    }
  });

  customerForm.addEventListener('submit', function(e){
    e.preventDefault();

    if(!selectedDate){
      status.style.color="red";
      status.textContent="Välj datum först!";
      return;
    }
    if(!timeSelect.value){
      status.style.color="red";
      status.textContent="Välj tid först!";
      return;
    }

    // Lagra bokad tid lokalt
    if(!bookedSlots[selectedDate]) bookedSlots[selectedDate]=[];
    bookedSlots[selectedDate].push(timeSelect.value);

    // Skicka med EmailJS
    let timeInput = customerForm.querySelector('input[name="time"]');
    if(!timeInput){
      timeInput = document.createElement('input');
      timeInput.type='hidden';
      timeInput.name='time';
      customerForm.appendChild(timeInput);
    }
    timeInput.value = selectedDate + " " + timeSelect.value;

    emailjs.sendForm('service_luw5k4u', 'template_cpux8e5', customerForm)
      .then(()=>{
        status.style.color="green";
        status.textContent="Bokning skickad! Bekräftelse skickas till kunden.";
        customerForm.reset();
        timeSelect.value="";
        timeSelect.style.display="none";
        selectedDate=null;
        generateCalendar(); // uppdatera kalendern med bokad tid
      }, (err)=>{
        status.style.color="red";
        status.textContent="Något gick fel, försök igen.";
        console.error("EmailJS Error:", err);
      });
  });
</script>

</body>
</html>
