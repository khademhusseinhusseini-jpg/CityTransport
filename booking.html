<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Boka flytt ‚Äì CityTransport</title>
<style>
  body{font-family:Arial, Helvetica, sans-serif;background:#f4f4f4;margin:0}
  header{background:#222;color:#fff;padding:26px 20px;display:flex;align-items:center;gap:16px}
  .home-link{color:#fff;text-decoration:none;font-size:1.4rem;padding:6px 10px;border-radius:6px;background:rgba(255,255,255,0.06)}
  header h1{margin:0;font-size:1.6rem}
  header p{margin:0;color:#ddd;font-size:0.95rem}
  .wrap{max-width:980px;margin:28px auto;padding:22px;background:#fff;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.08)}
  #month-nav{text-align:center;margin-bottom:12px}
  #month-nav button{margin:0 6px;padding:8px 12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
  #calendar table{width:100%;border-collapse:collapse}
  #calendar th{background:#fafafa;padding:12px;color:#333}
  #calendar td{padding:14px;text-align:center;border:1px solid #fafafa;min-height:64px;vertical-align:top}
  #calendar td.available{cursor:pointer}
  #calendar td.available:hover{background:#eaf9ea}
  #calendar td.partial{background:#fffdf5}
  #calendar td.full{background:#fff0f0;color:#333}
  .day-number{font-weight:700}
  .booked-list{margin-top:8px;font-size:0.85rem;color:#b02020}
  .booked-list span{display:inline-block;margin:3px 5px;padding:3px 6px;background:#fff6f6;border-radius:4px;border:1px solid #f1cfcf}
  .controls{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:14px}
  #time-select{display:none;padding:8px;border-radius:6px;border:1px solid #ccc}
  #customer-form{display:none;max-width:520px;margin:18px auto;text-align:left}
  #customer-form input,#customer-form textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:6px;border:1px solid #ddd}
  #customer-form button{width:100%;padding:12px;background:#0077cc;color:#fff;border:none;border-radius:8px;cursor:pointer}
  #status{margin-top:12px;text-align:center;font-weight:600}
</style>
</head>
<body>

<header>
  <a class="home-link" href="index.html" title="Startsida">üè† Hem</a>
  <div>
    <h1>CityTransport ‚Äî Boka flytt</h1>
    <p>Vard: 16‚Äì24 / Helg: 08‚Äì24 ‚Äî intervall 4 h. Klicka en dag f√∂r lediga tider.</p>
  </div>
</header>

<div class="wrap">
  <div id="month-nav">
    <button id="prev-month">&lt; F√∂reg√•ende</button>
    <strong id="current-month"></strong>
    <button id="next-month">N√§sta &gt;</button>
  </div>

  <div id="calendar"></div>

  <div class="controls">
    <select id="time-select"><option value="">V√§lj tid</option></select>
  </div>

  <form id="customer-form">
    <input id="name" name="name" placeholder="Ditt namn" required />
    <input id="email" name="email" type="email" placeholder="Din e-post" required />
    <input id="phone" name="phone" placeholder="Telefon" required />
    <textarea id="message" name="message" placeholder="Meddelande (valfritt)"></textarea>
    <button type="submit">Skicka bokning</button>
  </form>

  <div id="status"></div>
</div>

<!-- EmailJS (optional) -->
<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<script>
/* --- KONFIG ‚Äî ers√§tt dessa --- */
const GAS_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYED_WEBAPP_ID/exec'; // Ers√§tt med din Web App URL (fr√•n Apps Script)
const EMAILJS_PUBLIC_KEY = 'E7HH_m3tC91tBo8Vr'; // ev. din EmailJS public key
const EMAILJS_SERVICE_ID = 'service_luw5k4u';   // din EmailJS service id
const EMAILJS_TEMPLATE_ADMIN = 'template_cpux8e5'; // admin template
const EMAILJS_TEMPLATE_CUSTOMER = 'template_j6ztrpp'; // kund template (valfritt)
emailjs.init(EMAILJS_PUBLIC_KEY);
/* -------------------------- */

let bookings = {}; // "YYYY-MM-DD": ["08:00",...]
let current = new Date();
let currentYear = current.getFullYear(), currentMonth = current.getMonth();
const calendarEl = document.getElementById('calendar');
const monthLabel = document.getElementById('current-month');
const timeSelect = document.getElementById('time-select');
const customerForm = document.getElementById('customer-form');
const statusEl = document.getElementById('status');
let selectedDate = null;

/* Hj√§lpare: ber√§kna alla m√∂jliga slot f√∂r en dag (4h intervall).
   M√•ndag‚ÄìFredag start 16 -> 16,20
   L√∂rdag & S√∂ndag start 08 -> 08,12,16,20
   (slutar f√∂re midnatt; sista slot 20:00) */
function getWorkingSlotsForDate(dateStr){
  const d = new Date(dateStr + 'T00:00');
  const day = d.getDay(); // 0=Sun,1=Mon,...6=Sat
  const isWeekend = (day === 0 || day === 6);
  const startHour = isWeekend ? 8 : 16;
  const slots = [];
  for(let h = startHour; h < 24; h += 4){
    slots.push((h < 10 ? '0'+h : h) + ':00');
  }
  return slots;
}

/* H√§mta bokningar fr√•n GAS f√∂r en m√•nad */
async function loadBookings(year, month){ // month: 1-12
  try {
    const res = await fetch(`${GAS_URL}?action=getBookings&year=${year}&month=${String(month).padStart(2,'0')}`);
    const json = await res.json();
    if(json.status === 'ok') bookings = json.bookings || {};
    else bookings = {};
  } catch(err){
    console.error('Fetch bookings failed', err);
    bookings = {}; // fallback
  }
}

/* Returnera lediga tider (ej bokade) f√∂r dateStr */
function getAvailableTimes(dateStr){
  const all = getWorkingSlotsForDate(dateStr);
  const booked = bookings[dateStr] || [];
  return all.filter(t => !booked.includes(t));
}

/* Rendera kalender ‚Äî h√§mtar bookings f√∂r m√•n innan rendering */
async function renderCalendar(year, monthIndex){
  await loadBookings(year, monthIndex + 1); // monthIndex 0-based -> send 1-based
  const first = new Date(year, monthIndex, 1);
  const last = new Date(year, monthIndex + 1, 0);
  const weekdays = ['S√∂n','M√•n','Tis','Ons','Tor','Fre','L√∂r'];
  monthLabel.textContent = first.toLocaleString('sv-SE', {month:'long', year:'numeric'});

  let html = '<table><tr>';
  weekdays.forEach(w => html += `<th>${w}</th>`);
  html += '</tr><tr>';

  for(let i=0;i<first.getDay();i++) html += '<td class="empty"></td>';

  for(let day=1; day<= last.getDate(); day++){
    const d = new Date(year, monthIndex, day);
    const dayStr = d.toISOString().split('T')[0];
    const daySlots = getWorkingSlotsForDate(dayStr);
    const bookedArr = bookings[dayStr] || [];
    const isFull = bookedArr.length >= daySlots.length;
    const cls = isFull ? 'full' : (bookedArr.length ? 'partial' : 'available');

    html += `<td class="${cls}" data-date="${dayStr}"><span class="day-number">${day}</span>`;
    if(bookedArr.length){
      html += `<div class="booked-list">`;
      bookedArr.slice(0,6).forEach(t => html += `<span>${t}</span>`);
      if(bookedArr.length > 6) html += `<small> +${bookedArr.length - 6} fler</small>`;
      html += `</div>`;
    }
    html += `</td>`;

    if((day + first.getDay()) % 7 === 0) html += '</tr><tr>';
  }
  html += '</tr></table>';
  calendarEl.innerHTML = html;

  document.querySelectorAll('#calendar td.available, #calendar td.partial').forEach(td => {
    td.addEventListener('click', () => {
      selectedDate = td.dataset.date;
      const times = getAvailableTimes(selectedDate);
      timeSelect.innerHTML = '<option value="">V√§lj tid</option>';
      times.forEach(t => {
        const opt = document.createElement('option'); opt.value = t; opt.textContent = t;
        timeSelect.appendChild(opt);
      });
      if(times.length === 0){
        timeSelect.style.display = 'none';
        statusEl.style.color = '#b02020';
        statusEl.textContent = 'Inga lediga tider denna dag.';
      } else {
        timeSelect.style.display = 'inline-block';
        statusEl.textContent = '';
      }
      customerForm.style.display = 'none';
    });
  });

  document.querySelectorAll('#calendar td.full').forEach(td=>{
    td.addEventListener('click', ()=>{
      selectedDate = null;
      timeSelect.style.display = 'none';
      customerForm.style.display = 'none';
      statusEl.style.color = '#b02020';
      statusEl.textContent = 'Denna dag √§r fullbokad.';
    });
  });
}

/* M√•nadsnavigering */
document.getElementById('prev-month').addEventListener('click', ()=>{
  currentMonth--; if(currentMonth < 0){ currentMonth = 11; currentYear--; }
  renderCalendar(currentYear, currentMonth);
});
document.getElementById('next-month').addEventListener('click', ()=>{
  currentMonth++; if(currentMonth > 11){ currentMonth = 0; currentYear++; }
  renderCalendar(currentYear, currentMonth);
});

/* init */
renderCalendar(currentYear, currentMonth);

/* times select */
timeSelect.addEventListener('change', ()=> {
  customerForm.style.display = timeSelect.value ? 'block' : 'none';
});

/* submit */
customerForm.addEventListener('submit', async function(e){
  e.preventDefault();
  const name = this.name.value.trim();
  const email = this.email.value.trim();
  const phone = this.phone.value.trim();
  const message = this.message.value.trim();
  const time = timeSelect.value;
  if(!selectedDate){ statusEl.style.color='red'; statusEl.textContent='V√§lj datum f√∂rst.'; return; }
  if(!time){ statusEl.style.color='red'; statusEl.textContent='V√§lj tid f√∂rst.'; return; }

  // 1) spara i Sheet via GAS
  const payload = {
    action: 'addBooking',
    date: selectedDate,
    time: time,
    name: name,
    email: email,
    phone: phone,
    message: message
  };

  try {
    const res = await fetch(GAS_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    if(json.status !== 'ok') throw new Error(json.message || 'save failed');

    // 2) uppdatera lokalt och UI
    if(!bookings[selectedDate]) bookings[selectedDate] = [];
    bookings[selectedDate].push(time);
    bookings[selectedDate].sort();
    renderCalendar(currentYear, currentMonth);

    // 3) skicka mail via EmailJS (admin + kund) ‚Äî valfritt
    // Skicka admin-mail
    try {
      // prepare form-like object for send
      const formForEmail = {
        name: name,
        email: email,
        phone: phone,
        time: selectedDate + ' ' + time,
        message: message
      };
      // EmailJS: admin
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ADMIN, formForEmail);
      // EmailJS: customer (valfritt)
      // await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_CUSTOMER, formForEmail);
    } catch(mailErr){
      console.warn('EmailJS failed:', mailErr);
    }

    statusEl.style.color = 'green';
    statusEl.textContent = 'Bokning sparad! Bekr√§ftelse skickas via e-post.';
    this.reset();
    timeSelect.style.display = 'none';
    selectedDate = null;
  } catch(err){
    console.error(err);
    statusEl.style.color = 'red';
    statusEl.textContent = 'Kunde inte spara bokning ‚Äî f√∂rs√∂k igen.';
  }
});
</script>
</body>
</html>
